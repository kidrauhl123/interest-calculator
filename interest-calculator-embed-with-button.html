<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复利计算器与图表展示器（含定投）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
<script>
  // Register annotation plugin early so it's available before the first chart is created
  if (window['chartjs-plugin-annotation'] && window.Chart) {
    Chart.register(window['chartjs-plugin-annotation']);
  }
</script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">复利计算器</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div>
                <label for="principal" class="block text-sm font-medium text-gray-600 mb-2">初始本金 (元)</label>
                <input type="number" id="principal" value="1000" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" min="0" step="0.01">
            </div>
            <div>
                <label for="rate" class="block text-sm font-medium text-gray-600 mb-2">年利率 (%)</label>
                <input type="number" id="rate" value="5" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" min="0" step="0.01">
            </div>
            <div>
                <label for="years" class="block text-sm font-medium text-gray-600 mb-2">投资年数</label>
                <input type="number" id="years" value="10" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" min="1" step="1">
            </div>
            <div>
                <label for="compound" class="block text-sm font-medium text-gray-600 mb-2">复利频率 (次/年)</label>
                <select id="compound" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="1">每年</option>
                    <option value="4">每季度</option>
                    <option value="12" selected>每月</option>
                </select>
            </div>
            <div>
                <label for="pmt" class="block text-sm font-medium text-gray-600 mb-2">定期投资金额 (每次复利周期，元)</label>
                <input type="number" id="pmt" value="0" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" min="0" step="0.01">
            </div>
            <div>
                <label for="milestoneInterval" class="block text-sm font-medium text-gray-600 mb-2">里程碑间隔 (万)</label>
                <input type="number" id="milestoneInterval" value="50" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" min="1" step="1">
            </div>
            <div class="col-span-2">
                <label for="showKeyPoints" class="inline-flex items-center">
                    <input type="checkbox" id="showKeyPoints" checked class="mr-2 h-4 w-4 text-blue-500 focus:ring-blue-500 border-gray-300 rounded">
                    <span class="text-sm font-medium text-gray-600">显示关键节点 (整数年 & 里程碑)</span>
                </label>
            </div>
        </div>
        
        <button id="calculate" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition mb-8">计算</button>
        
        <div id="result" class="mb-8 hidden">
            <h2 class="text-2xl font-semibold mb-3 text-gray-800">计算结果</h2>
            <p id="finalAmount" class="text-lg text-gray-700"></p>
        </div>
        
        <div id="milestones" class="mb-8 hidden">
            <h2 class="text-2xl font-semibold mb-3 text-gray-800">里程碑时间</h2>
            <ul id="milestoneList" class="list-disc pl-6 text-gray-700"></ul>
        </div>
        
        <canvas id="chart" class="w-full h-80"></canvas>
    </div>

    <script>
// ====== Embed & Config & Persistence helper (runs before main chart script) ======

// Helper to get elements
function $el(id){ return document.getElementById(id); }

// Read config from URL (?config=base64(json)) and mode=embed
const __qs = new URLSearchParams(location.search);
const __EMBED_MODE = __qs.get('mode') === 'embed';

function __decodeConfig(s){
  try { return JSON.parse(decodeURIComponent(atob(s))); } catch(e){ return null; }
}
const __URL_CFG = __qs.get('config') ? __decodeConfig(__qs.get('config')) : null;

// Local storage helpers
const __LS_KEY = 'ci-config-v1';
function __saveToLocal(cfg){
  try { localStorage.setItem(__LS_KEY, JSON.stringify(cfg)); } catch(e){}
}
function __loadFromLocal(){
  try { return JSON.parse(localStorage.getItem(__LS_KEY) || 'null'); } catch(e){ return null; }
}

// Apply a cfg object to inputs (only if present)
function __applyConfig(cfg){
  if (!cfg) return;
  if (cfg.principal!=null && $el('principal')) $el('principal').value = cfg.principal;
  if (cfg.rate!=null && $el('rate')) $el('rate').value = cfg.rate;
  if (cfg.years!=null && $el('years')) $el('years').value = cfg.years;
  if (cfg.compound!=null && $el('compound')) $el('compound').value = cfg.compound;
  if (cfg.pmt!=null && $el('pmt')) $el('pmt').value = cfg.pmt;
  if (cfg.milestoneInterval!=null && $el('milestoneInterval')) $el('milestoneInterval').value = cfg.milestoneInterval;
  if (cfg.showKeyPoints!=null && $el('showKeyPoints')) $el('showKeyPoints').checked = !!cfg.showKeyPoints;
}

// Gather current inputs into cfg
function __gatherConfig(){
  return {
    principal: $el('principal') ? +$el('principal').value : undefined,
    rate: $el('rate') ? +$el('rate').value : undefined,
    years: $el('years') ? +$el('years').value : undefined,
    compound: $el('compound') ? +$el('compound').value : undefined,
    pmt: $el('pmt') ? +$el('pmt').value : undefined,
    milestoneInterval: $el('milestoneInterval') ? +$el('milestoneInterval').value : undefined,
    showKeyPoints: $el('showKeyPoints') ? !!$el('showKeyPoints').checked : undefined,
  };
}

// Initialize config: URL > localStorage > keep defaults
(function __initCfg(){
  if (__URL_CFG) {
    __applyConfig(__URL_CFG);
  } else {
    const last = __loadFromLocal();
    if (last) __applyConfig(last);
  }
})();

// Hook inputs to persist changes and (later) trigger chart updates
(function __hookInputs(){
  const inputs = document.querySelectorAll('input:not(#showKeyPoints), select');
  inputs.forEach(inp => {
    inp.addEventListener('input', () => {
      __saveToLocal(__gatherConfig());
      // updateChart will be defined in the main script; if present, update
      if (typeof updateChart === 'function') { 
        if (typeof activeAnnotation !== 'undefined') { activeAnnotation = null; }
        updateChart();
      }
    });
  });
  const chk = $el('showKeyPoints');
  if (chk) {
    chk.addEventListener('change', () => {
      __saveToLocal(__gatherConfig());
      if (typeof updateChart === 'function') { 
        if (typeof activeAnnotation !== 'undefined') { activeAnnotation = null; }
        updateChart();
      }
    });
  }
})();

// Embed mode: hide everything except the chart canvas
(function __applyEmbedMode(){
  if (!__EMBED_MODE) return;
  const keepIds = new Set(['chart']);
  document.querySelectorAll('body *').forEach(el => {
    if (el.id && keepIds.has(el.id)) return;
    // keep the ancestors of kept nodes
    let keep = false, p = el;
    while (p) { if (p.id && keepIds.has(p.id)) { keep = true; break; } p = p.parentElement; }
    if (!keep) el.style.display = 'none';
  });
  document.body.style.margin = '0';
  document.body.className = '';
  const c = $el('chart');
  if (c) { c.style.width = '100%'; c.style.height = '80vh'; }
})();

// If URL provided a config, ensure first render uses it: after window load, call updateChart if exists
window.addEventListener('load', () => {
  if (typeof updateChart === 'function') { 
    if (typeof activeAnnotation !== 'undefined') { activeAnnotation = null; }
    updateChart();
  }
});
</script>

<script>
        const ctx = document.getElementById('chart').getContext('2d');
        let chart;
        let activeAnnotation = null;

        function calculateCompoundInterest() {
            const principal = parseFloat(document.getElementById('principal').value);
            const rate = parseFloat(document.getElementById('rate').value) / 100;
            const years = parseInt(document.getElementById('years').value);
            const compound = parseInt(document.getElementById('compound').value);
            const pmt = parseFloat(document.getElementById('pmt').value);

            const periods = years * compound;
            const ratePerPeriod = rate / compound;

            let finalAmount;
            if (pmt === 0) {
                finalAmount = principal * Math.pow(1 + ratePerPeriod, periods);
            } else {
                finalAmount = principal * Math.pow(1 + ratePerPeriod, periods) +
                              pmt * (Math.pow(1 + ratePerPeriod, periods) - 1) / ratePerPeriod;
            }

            document.getElementById('finalAmount').textContent = `最终金额: ${finalAmount.toFixed(2)} 元`;
            document.getElementById('result').classList.remove('hidden');

            return finalAmount;
        }

        function updateChart() {
            const principal = parseFloat(document.getElementById('principal').value);
            const rate = parseFloat(document.getElementById('rate').value) / 100;
            const years = parseInt(document.getElementById('years').value);
            const compound = parseInt(document.getElementById('compound').value);
            const pmt = parseFloat(document.getElementById('pmt').value);
            const milestoneInterval = parseFloat(document.getElementById('milestoneInterval').value) * 10000;
            const showKeyPoints = document.getElementById('showKeyPoints').checked;

            const periods = years * compound;
            const ratePerPeriod = rate / compound;

            const data = [];
            const milestoneTimes = [];
            let current = principal;
            let lastMilestone = Math.floor(principal / milestoneInterval) * milestoneInterval;
            let prevTime = 0;

            // 计算整数年节点
            const yearPoints = [];
            for (let year = 0; year <= years; year++) {
                if (Number.isInteger(year)) {
                    yearPoints.push(parseFloat(year.toFixed(1)));
                }
            }

            // 计算里程碑节点
            const milestonePoints = [];
            let milestoneAmount = Math.floor(principal / milestoneInterval) * milestoneInterval;

            // 计算每月节点（用于tooltip）
            const monthlyPoints = [];
            for (let year = 0; year <= years; year++) {
                for (let month = 0; month <= 12; month++) {
                    const time = year + month / 12;
                    if (time <= years) {
                        monthlyPoints.push(parseFloat(time.toFixed(3)));
                    }
                }
            }

            // 存储关键节点数据
            const keyPointData = [];
            for (let i = 0; i <= periods; i++) {
                const yearFraction = i / compound;
                let pointRadius = 0;
                let pointColor = 'rgb(59, 130, 246)'; // Default blue for curve

                if (showKeyPoints) {
                    if (yearPoints.includes(parseFloat(yearFraction.toFixed(1)))) {
                        pointRadius = 5;
                        pointColor = 'rgb(59, 130, 246)'; // Blue for integer years
                    } else if (current >= milestoneAmount + milestoneInterval && !milestonePoints.includes(yearFraction)) {
                        milestoneAmount += milestoneInterval;
                        milestonePoints.push(yearFraction);
                        pointRadius = 5;
                        pointColor = 'rgb(239, 68, 68)'; // Red for milestone intervals
                    }
                }

                data.push({ x: yearFraction, y: current.toFixed(2), radius: pointRadius, backgroundColor: pointColor });

                if (yearPoints.includes(parseFloat(yearFraction.toFixed(1))) || milestonePoints.includes(yearFraction)) {
                    keyPointData.push({ time: yearFraction, amount: current, isMilestone: milestonePoints.includes(yearFraction) });
                }

                // 检查用户定义的里程碑（用于列表）
                while (current >= lastMilestone + milestoneInterval) {
                    lastMilestone += milestoneInterval;
                    const timePassed = yearFraction - prevTime;
                    const y = Math.floor(timePassed);
                    const m = Math.round((timePassed - y) * 12);
                    milestoneTimes.push(`从 ${formatAmount(lastMilestone - milestoneInterval)} 到 ${formatAmount(lastMilestone)}: ${y} 年 ${m} 个月`);
                    prevTime = yearFraction;
                }

                if (i < periods) {
                    current *= (1 + ratePerPeriod);
                    current += pmt;
                }
            }

            // 显示里程碑列表
            const milestoneList = document.getElementById('milestoneList');
            milestoneList.innerHTML = '';
            milestoneTimes.forEach(time => {
                const li = document.createElement('li');
                li.textContent = time;
                milestoneList.appendChild(li);
            });
            document.getElementById('milestones').classList.remove('hidden');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '本金增长',
                        data: data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1,
                        pointRadius: data.map(d => d.radius),
                        pointHoverRadius: 7,
                        pointBackgroundColor: data.map(d => d.backgroundColor),
                        pointBorderColor: 'rgb(255, 255, 255)',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: '年份',
                                color: 'rgb(55, 65, 81)',
                                font: { size: 14 }
                            },
                            min: 0,
                            max: years
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '金额 (元)',
                                color: 'rgb(55, 65, 81)',
                                font: { size: 14 }
                            }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: activeAnnotation ? [activeAnnotation] : []
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'nearest',
                            intersect: true,
                            callbacks: {
                                title: function(tooltipItems) {
                                    if (!tooltipItems || !tooltipItems.length) return '';
                                    const item = tooltipItems[0];
                                    if (!item || !item.parsed) return '';
                                    const x = parseFloat(item.parsed.x.toFixed(3));
                                    const closestMonth = monthlyPoints.reduce((prev, curr) =>
                                        Math.abs(curr - x) < Math.abs(prev - x) ? curr : prev
                                    );
                                    const y = Math.floor(closestMonth);
                                    const m = Math.round((closestMonth - y) * 12);
                                    return m === 0 ? `${y} 年` : `${y} 年 ${m} 个月`;
                                },
                                label: function(tooltipItem) {
                                    if (!tooltipItem || !tooltipItem.parsed) return '';
                                    return `${formatAmount(tooltipItem.parsed.y)}`;
                                }
                            }
                        }
                    },
                    onClick: (event, elements, chart) => {
                        if (elements.length) {
                            const index = elements[0].index;
                            const point = data[index];
                            const x = parseFloat(point.x.toFixed(1));
                            const isKeyPoint = yearPoints.includes(x) || milestonePoints.includes(x);
                            if (isKeyPoint) {
                                const y = Math.floor(point.x);
                                const m = Math.round((point.x - y) * 12);
                                const label = milestonePoints.includes(x)
                                    ? `${formatAmount(point.y)}`
                                    : `${y}年${m ? m + '个月' : ''}: ${formatAmount(point.y)}`;
                                if (activeAnnotation && activeAnnotation.label.content === label) {
                                    activeAnnotation = null;
                                } else {
                                    activeAnnotation = {
                                        type: 'label',
                                        xValue: point.x,
                                        yValue: point.y,
                                        content: label,
                                        backgroundColor: milestonePoints.includes(x) ? 'rgba(239, 68, 68, 0.8)' : 'rgba(59, 130, 246, 0.8)',
                                        font: { size: 10 },
                                        padding: 6,
                                        position: 'center',
                                        yAdjust: -20
                                    };
                                }
                                chart.options.plugins.annotation.annotations = activeAnnotation ? [activeAnnotation] : [];
                                chart.update();
                            }
                        }
                    }
                }
            });
        }

        function formatAmount(amount) {
            return (amount / 10000).toFixed(2) + ' 万元';
        }

        document.getElementById('calculate').addEventListener('click', () => {
            calculateCompoundInterest();
            updateChart();
        });

        document.getElementById('showKeyPoints').addEventListener('change', () => {
            activeAnnotation = null;
            updateChart();
        });

        document.querySelectorAll('input:not(#showKeyPoints), select').forEach(input => {
            input.addEventListener('input', () => {
                activeAnnotation = null;
                updateChart();
            });
        });

        // 初始化图表
        updateChart();
    </script>

<script>
// ===== Export Embed Link Button =====
(function () {
  function $(id){ return document.getElementById(id); }
  function encodeCfg(cfg){ return btoa(encodeURIComponent(JSON.stringify(cfg))); }
  function gatherCfg(){
    const getNum = (id) => { const el = $(id); return el ? +el.value : undefined; };
    const getChk = (id) => { const el = $(id); return el ? !!el.checked : undefined; };
    return {
      principal: getNum('principal'),
      rate: getNum('rate'),
      years: getNum('years'),
      compound: getNum('compound'),
      pmt: getNum('pmt'),
      milestoneInterval: getNum('milestoneInterval'),
      showKeyPoints: getChk('showKeyPoints'),
    };
  }

  function createBtn(){
    const btn = document.createElement('button');
    btn.id = 'export-embed-link';
    btn.type = 'button';
    btn.textContent = '导出嵌入链接（仅图表）';
    btn.className = 'w-full bg-emerald-600 text-white py-3 px-4 rounded-lg hover:bg-emerald-700 transition mb-3';
    btn.addEventListener('click', async () => {
      try {
        const cfg = gatherCfg();
        // Prefer this same file's path; works whether file is index.html or *-embed.html
        const base = location.origin + location.pathname;
        const url = `${base}?mode=embed&config=${encodeCfg(cfg)}`;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(url);
          btn.textContent = '✅ 已复制嵌入链接';
          setTimeout(()=>btn.textContent='导出嵌入链接（仅图表）', 1600);
        } else {
          // Fallback: show prompt
          const ok = window.prompt('复制下面的嵌入链接：', url);
          if (ok !== null) {
            btn.textContent = '✅ 链接已生成';
            setTimeout(()=>btn.textContent='导出嵌入链接（仅图表）', 1600);
          }
        }
      } catch (e) {
        console.error(e);
        btn.textContent = '❌ 生成失败，查看控制台';
        setTimeout(()=>btn.textContent='导出嵌入链接（仅图表）', 2000);
      }
    });
    return btn;
  }

  function placeBtn(){
    const btn = createBtn();
    const calc = $('calculate');
    if (calc && calc.parentElement) {
      calc.insertAdjacentElement('afterend', btn);
    } else {
      // if calculate button not found, append to container
      const container = document.querySelector('.max-w-5xl') || document.body;
      container.prepend(btn);
    }
  }

  // run after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', placeBtn);
  } else {
    placeBtn();
  }
})();
</script>

</body>
</html>